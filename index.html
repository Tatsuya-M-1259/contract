<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天草市 随意契約判定ガイド</title>
    
    <!-- PWA設定: マニフェストとアイコンの読み込み -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192x192.png">
    <meta name="theme-color" content="#10B981">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムフォントと基本設定 */
        :root {
            --primary-color: #10B981; /* Emerald */
            --secondary-color: #059669; /* Dark Emerald */
            --warning-color: #F59E0B; /* Amber */
            --step-color: #3B82F6; /* Blue */
            --attention-color: #EF4444; /* Red */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .contract-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2310B981'%3e%3cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
        }
        .result-box {
            border-left: 5px solid var(--primary-color);
            transition: all 0.5s ease-in-out;
        }
        .step-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .step-number {
            flex-shrink: 0;
            width: 2rem;
            height: 2rem;
            background-color: var(--step-color);
            color: white;
            border-radius: 9999px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 0.75rem;
        }
        /* 依頼先強調スタイル */
        .office-attention {
            background-color: #FEF2F2; /* Red 50 */
            border-left: 5px solid var(--attention-color);
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-weight: bold;
            color: #B91C1C; /* Red 700 */
        }

        /* 印刷用スタイル設定 */
        @media print {
            body {
                background-color: white;
                color: black;
                font-size: 12pt;
            }
            /* 印刷時に非表示にする要素 */
            .no-print, header, .bg-amber-100, .contract-card:first-child, #installBtnContainer { 
                display: none !important; 
            }
            
            /* 結果エリアの表示調整 */
            .result-box {
                display: block !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            /* グリッド解除 */
            .grid {
                display: block !important;
            }
            /* 印刷タイトル追加 */
            .result-box::before {
                content: "【判定結果】 天草市 随意契約判定ガイド";
                font-size: 16pt;
                font-weight: bold;
                display: block;
                margin-bottom: 20px;
                border-bottom: 2px solid #000;
            }
            /* 強調表示のリセット */
            .text-emerald-600, .text-red-500, .text-orange-500 {
                color: black !important;
                text-decoration: underline;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-6 relative">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 border-b-4 border-emerald-500 pb-2 inline-block">天草市 随意契約 根拠条文 判定ナビ</h1>
            <p class="mt-3 text-lg font-bold text-gray-700">
                本アプリは、一般競争入札の原則に対する<span class="text-red-600">例外規定（随意契約）</span>の<span class="underline">適正な判断と手続き</span>をサポートします。
            </p>
            
            <!-- インストールボタン (初期状態は非表示) -->
            <div id="installBtnContainer" class="hidden mt-4">
                <button id="installBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-lg flex items-center justify-center mx-auto transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    アプリをインストール
                </button>
            </div>
        </header>

        <!-- 注意喚起バナー -->
        <div class="bg-amber-100 border-l-4 border-amber-500 p-4 mb-8 rounded-lg shadow-md">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-amber-600 mr-3">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <p class="text-sm font-medium text-amber-800">
                    **【基本原則】** 随意契約は地方自治法上、**一般競争入札の例外**です。適用にあたっては、根拠、理由、業者選定を明確に記録する必要があります。
                </p>
            </div>
        </div>

        <!-- メインコンテンツグリッド -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- 入力/判定エリア (印刷時は非表示) -->
            <div class="bg-white p-6 sm:p-8 rounded-xl contract-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-emerald-600">契約情報の入力</h2>
                    <!-- リセットボタン -->
                    <button onclick="resetForm()" class="text-xs text-gray-500 hover:text-red-500 underline">
                        入力をクリア
                    </button>
                </div>
                
                <!-- 1. 契約の種類 -->
                <div class="mb-5">
                    <label for="contractType" class="block text-sm font-medium text-gray-700 mb-1">1. 契約の種類</label>
                    <select id="contractType" class="custom-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md shadow-sm">
                        <option value="">選択してください</option>
                        <option value="1">工事又は製造の請負 (例: 印刷物含む)</option>
                        <option value="2">財産の買入れ (例: 土地、備品)</option>
                        <option value="3">物件の借入れ (例: 契約期間中の賃借料総額)</option>
                        <option value="4">財産の売払い</option>
                        <option value="5">物件の貸付け (例: 契約期間中の賃貸料総額)</option>
                        <option value="6">前各号に掲げる以外のもの (例: 業務委託、役務の提供)</option>
                    </select>
                </div>

                <!-- 2. 予定価格 (改善版) -->
                <div class="mb-6">
                    <label for="plannedPrice" class="block text-sm font-medium text-gray-700 mb-1">2. 予定価格 (税抜・単位: 万円)</label>
                    <div class="relative">
                        <input type="number" id="plannedPrice" min="0" placeholder="例: 150" oninput="updatePricePreview(this.value)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                        <!-- 単位プレビュー -->
                        <div id="pricePreview" class="absolute right-3 top-2.5 text-gray-400 text-sm font-mono pointer-events-none">0 円</div>
                    </div>
                    <p class="mt-1 text-xs text-red-500 font-bold">※「100万円」の場合は「100」と入力してください</p>
                    <p class="mt-1 text-xs text-gray-500">※施行令第167条の2第1項第1号の金額判定に使用します。</p>
                </div>

                <!-- 3. 特殊な随意契約事由 (第2号〜第9号) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">3. 特殊な契約事由 (該当する場合)</label>
                    <div class="space-y-2 text-sm bg-gray-50 p-3 rounded-md border border-gray-100">
                        <div class="flex items-start">
                            <input id="reasonNone" name="specialReason" type="radio" value="0" checked class="focus:ring-emerald-500 h-4 w-4 text-emerald-600 border-gray-300 mt-1">
                            <label for="reasonNone" class="ml-3 block text-gray-900 font-bold">該当する特殊事由はない (価格のみで判定)</label>
                        </div>
                        <hr class="my-2 border-gray-200">
                        <div class="flex items-start">
                            <input id="reason2" name="specialReason" type="radio" value="2" class="focus:ring-emerald-500 h-4 w-4 text-emerald-600 border-gray-300 mt-1">
                            <label for="reason2" class="ml-3 block text-gray-900">第2号: 性質・目的が競争入札に適しない (特殊技術/特許権/不動産/コンペ等)</label>
                        </div>
                        <div class="flex items-start">
                            <input id="reason3" name="specialReason" type="radio" value="3" class="focus:ring-emerald-500 h-4 w-4 text-emerald-600 border-gray-300 mt-1">
                            <label for="reason3" class="ml-3 block text-gray-900">第3号: 福祉施設等 (障害者支援施設/シルバー人材センター/母子福祉団体等)</label>
                        </div>
                        <div class="flex items-start">
                            <input id="reason5" name="specialReason" type="radio" value="5" class="focus:ring-emerald-500 h-4 w-4 text-emerald-600 border-gray-300 mt-1">
                            <label for="reason5" class="ml-3 block text-gray-900">第5号: 緊急の必要 (災害/応急復旧/蔓延防止等)</label>
                        </div>
                        <div class="flex items-start">
                            <input id="reason6" name="specialReason" type="radio" value="6" class="focus:ring-emerald-500 h-4 w-4 text-emerald-600 border-gray-300 mt-1">
                            <label for="reason6" class="ml-3 block text-gray-900">第6号: 競争入札に付することが不利 (追加工事/継続業務で有利等)</label>
                        </div>
                        <div class="flex items-start">
                            <input id="reason7" name="specialReason" type="radio" value="7" class="focus:ring-emerald-500 h-4 w-4 text-emerald-600 border-gray-300 mt-1">
                            <label for="reason7" class="ml-3 block text-gray-900">第7号: 時価に比べて著しく有利な価格での契約見込み (原版保有印刷物等)</label>
                        </div>
                        <div class="flex items-start">
                            <input id="reason8" name="specialReason" type="radio" value="8" class="focus:ring-emerald-500 h-4 w-4 text-emerald-600 border-gray-300 mt-1">
                            <label for="reason8" class="ml-3 block text-gray-900">第8号: 入札者がない/再度の入札で落札者がない (入札不調)</label>
                        </div>
                        <div class="flex items-start">
                            <input id="reason9" name="specialReason" type="radio" value="9" class="focus:ring-emerald-500 h-4 w-4 text-emerald-600 border-gray-300 mt-1">
                            <label for="reason9" class="ml-3 block text-gray-900">第9号: 落札者が契約を締結しない (落札者辞退等)</label>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button onclick="judgeContract()" class="flex-1 py-3 bg-emerald-500 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-600 transition duration-150">
                        契約根拠を判定する
                    </button>
                    <!-- リセットボタン (モバイル用にも配置) -->
                    <button onclick="resetForm()" class="px-4 py-3 bg-gray-200 text-gray-600 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                        クリア
                    </button>
                </div>
            </div>

            <!-- 結果表示エリア -->
            <div id="resultOutput" class="bg-white p-6 sm:p-8 rounded-xl contract-card hidden result-box">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold text-secondary-color">判定結果と手続き</h2>
                    <!-- 印刷ボタン -->
                    <button onclick="window.print()" class="no-print flex items-center px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm border border-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                        印刷
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- 事務担当部署 -->
                    <div id="officeSection">
                        <p class="text-xs font-semibold uppercase text-gray-500">事務担当部署</p>
                        <div id="resultOffice" class="office-attention text-base"></div>
                    </div>

                    <!-- 契約締結の形式 -->
                    <div id="contractFormSection">
                        <p class="text-xs font-semibold uppercase text-gray-500">契約締結の形式</p>
                        <p id="resultContractForm" class="text-xl font-extrabold text-red-500"></p>
                    </div>
                    
                    <!-- 根拠条文 -->
                    <div>
                        <p class="text-xs font-semibold uppercase text-gray-500">随意契約の根拠条文</p>
                        <p id="resultArticle" class="text-xl font-extrabold text-emerald-600"></p>
                    </div>

                    <!-- 見積徴取の要否 -->
                    <div>
                        <p class="text-xs font-semibold uppercase text-gray-500">見積徴取の要否</p>
                        <p id="resultQuotation" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    
                    <!-- 注意事項・必要書類 -->
                    <div>
                        <p class="text-xs font-semibold uppercase text-gray-500">注意事項と必要書類</p>
                        <div id="resultNotes" class="mt-2 p-3 bg-emerald-50 border-l-4 border-emerald-500 rounded-md text-sm text-gray-700 space-y-1">
                            <p id="note1"></p>
                            <p id="note2"></p>
                            <p id="note3"></p>
                            <p id="note4"></p>
                        </div>
                    </div>

                    <!-- 主管課における事務手順 -->
                    <div class="pt-4 border-t border-gray-200">
                        <p class="text-xs font-semibold uppercase text-gray-500 mb-3">主管課における事務手順 (ガイドライン P.10 参照)</p>
                        <div id="resultProcedure" class="space-y-2">
                            <!-- 手順はJSで動的に挿入されます -->
                        </div>
                    </div>
                    
                    <!-- 判定フロー補足 -->
                    <div class="pt-4 border-t border-gray-200">
                        <p class="text-xs font-semibold uppercase text-gray-500">判定フロー補足</p>
                        <p id="resultFlow" class="text-xs text-gray-600 mt-1 italic"></p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        /**
         * ==========================================
         * PWA Service Worker 登録 & インストール処理
         * ==========================================
         */
        // Service Workerの登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered.', reg))
                    .catch(err => console.log('Service Worker registration failed.', err));
            });
        }

        // インストールプロンプトの制御
        let deferredPrompt;
        const installBtnContainer = document.getElementById('installBtnContainer');
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Chromeの標準プロンプトを阻止
            e.preventDefault();
            deferredPrompt = e;
            // インストールボタンを表示
            installBtnContainer.classList.remove('hidden');
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            // プロンプトを表示
            deferredPrompt.prompt();
            // ユーザーの選択を待機
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
            // ボタンを非表示にする（任意）
            installBtnContainer.classList.add('hidden');
        });

        /**
         * ==========================================
         * 天草市 随意契約判定 コンフィグ設定エリア
         * ==========================================
         */
        const CONFIG = {
            PRICE_LIMITS: {
                '1': 200, // 工事又は製造の請負
                '2': 150, // 財産の買入れ
                '3': 80,  // 物件の借入れ
                '4': 50,  // 財産の売払い
                '5': 30,  // 物件の貸付け
                '6': 100  // 前各号に掲げる以外のもの
            },
            OFFICE_THRESHOLDS: {
                CONSTRUCTION: 20,
                GOODS: 20,
                RENTAL: 20,
                SERVICE: 50
            }
        };

        // 各随意契約事由の定義
        const REASON_DETAILS = {
            '2': { name: '第2号 (性質又は目的が競争入札に適しない)', oneParty: true, notes: '不動産の買入れ・借入れ、特殊技術、特許権等。契約の目的達成に特定の者が必要。', document: '「随意契約及び業者選定理由書」に採用した理由、業者選定理由を明確に記載すること。' },
            '3': { name: '第3号 (福祉関係施設等からの買入れ・役務)', oneParty: true, notes: '障害者支援施設等、シルバー人材センター、母子福祉団体等との契約。', document: '「随意契約及び業者選定理由書」に採用した理由、業者選定理由を明確に記載すること。**【重要】公表手続き（発注の見通し、契約締結後）が必要。**' },
            '5': { name: '第5号 (緊急の必要)', oneParty: true, notes: '天災地変等、予見し得ない緊急事態による。年度末等の予算執行上の都合は対象外。', document: '「随意契約及び業者選定理由書」に採用した理由、業者選定理由を明確に記載すること。' },
            '6': { name: '第6号 (競争入札に付することが不利)', oneParty: true, notes: '現履行中の受託者にさせた方が工期短縮、経費節減等で有利な場合。', document: '「随意契約及び業者選定理由書」に採用した理由、業者選定理由を明確に記載すること。' },
            '7': { name: '第7号 (時価に比べて著しく有利な価格)', oneParty: false, notes: '他の者に比べて著しく有利な価格で契約できる見込みがある場合。', document: '「随意契約及び業者選定理由書」に採用した理由、業者選定理由を明確に記載すること。**【重要】2者以上の者に見積書を依頼し、比較検討すること。**' },
            '8': { name: '第8号 (入札不調)', oneParty: false, notes: '入札者がない、又は再度の入札で落札者がない場合。', document: '「随意契約及び業者選定理由書」に採用した理由、業者選定理由を明確に記載すること。**【重要】契約保証金・履行期限を除き、当初の予定価格・条件を変更不可。**' },
            '9': { name: '第9号 (落札者が契約を締結しない)', oneParty: false, notes: '落札者が辞退・倒産等で契約締結しない場合。', document: '「随意契約及び業者選定理由書」に採用した理由、業者選定理由を明確に記載すること。**【重要】落札金額の制限内で見積合わせ。履行期限を除き、当初の条件を変更不可。**' },
        };

        // 主管課における事務手順
        const STANDARD_PROCEDURE = [
            { step: '執行(施行)伺書の作成', detail: '物品契約管理システムへ登録し、システムから出力 (工事は除く)。随意契約を採用した理由、業者を選定した理由等を記入する。**原則「随意契約及び業者選定理由書」を作成添付**。仕様書、カタログ等を添付。' },
            { step: '指名伺書の作成', detail: '業者へ通知書により見積依頼 (**原則として2者以上**)。指名業者に偏りが出ないよう考慮。見積期間は特別の場合を除き5日 (休日等を除く)が必要。' },
            { step: '見積書の開札', detail: '2名以上 (立会い者含む) で開札し、記載事項の点検。開札調書を作成。' },
            { step: '落札者の決定', detail: '開札後、見積書提出の全業者に結果を連絡。契約金額に応じた請書(案)または契約書(案)を作成。' },
            { step: '契約の締結', detail: '落札決定後速やかに (概ね1週間以内) 契約締結。' }
        ];

        function updatePricePreview(val) {
            const previewEl = document.getElementById('pricePreview');
            if (!val || val === '') { previewEl.innerText = "0 円"; return; }
            const yen = parseFloat(val) * 10000;
            if (isNaN(yen)) { previewEl.innerText = "数値エラー"; } else { previewEl.innerText = new Intl.NumberFormat('ja-JP').format(yen) + " 円"; }
        }

        function resetForm() {
            document.getElementById('contractType').value = "";
            document.getElementById('plannedPrice').value = "";
            document.getElementById('reasonNone').checked = true;
            updatePricePreview("");
            document.getElementById('resultOutput').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function determineContractOffice(type, price, specialReason) {
            const isOneParty = ['2', '3', '5', '6'].includes(specialReason);
            if (isOneParty) return '主管課';
            const thresholds = CONFIG.OFFICE_THRESHOLDS;
            switch (type) {
                case '1': if (price > thresholds.CONSTRUCTION) return '契約検査課 (競争入札が必要な案件)'; break;
                case '2': if (price > thresholds.GOODS) return '契約検査課'; break;
                case '3': if (price > thresholds.RENTAL) return '契約検査課'; break;
                case '6': if (price > thresholds.SERVICE) return '契約検査課'; break;
            }
            return '主管課';
        }

        function judgeContract() {
            const contractType = document.getElementById('contractType').value;
            const priceMan = parseFloat(document.getElementById('plannedPrice').value);
            const specialReasonElement = document.querySelector('input[name="specialReason"]:checked');
            const specialReason = specialReasonElement ? specialReasonElement.value : '0';
            const output = document.getElementById('resultOutput');
            
            if (!contractType || isNaN(priceMan) || priceMan < 0) {
                alert('契約の種類と予定価格を正しく入力してください。\n単位は「万円」です。');
                return;
            }

            let article = '', quotationDetail = '', notes = [], flowNote = '', contractFormDetail = ''; 
            const office = determineContractOffice(contractType, priceMan, specialReason);
            const resultOffice = document.getElementById('resultOffice');
            resultOffice.textContent = office === '主管課' ? '主管課で事務を行います' : `${office}へ依頼してください`;
            resultOffice.classList.toggle('office-attention', office !== '主管課');
            
            const resultContractForm = document.getElementById('resultContractForm');
            if (priceMan > 50) {
                contractFormDetail = '【契約書が必要】(50万円超)';
                resultContractForm.className = 'text-xl font-extrabold text-red-500';
                notes.push('**【契約締結形式】** 契約書が必要です。落札決定後速やかに契約書(案)を作成し、契約締結すること。');
            } else if (priceMan > 20) {
                contractFormDetail = '【請書が必要】(20万円超50万円以内)';
                resultContractForm.className = 'text-xl font-extrabold text-orange-500';
                notes.push('**【契約締結形式】** 請書(案)を作成し、契約締結すること。');
            } else {
                contractFormDetail = '【契約書・請書は原則不要】(20万円以下)';
                resultContractForm.className = 'text-xl font-extrabold text-emerald-600';
                notes.push('**【契約締結形式】** 契約書・請書は原則不要です。発注書や事務処理要領に基づき、適切に執行してください。');
            }

            const priceLimit = CONFIG.PRICE_LIMITS[contractType];
            const isMinorContract = priceMan <= priceLimit;
            const isSpecialReason = specialReason !== '0';
            
            if (isMinorContract) {
                article = `施行令第167条の2第1項第1号 (少額随契 - 上限${priceLimit}万円)`;
                if (priceMan <= 10) {
                    quotationDetail = '**1者のみの徴取で足りる** (規則第14条第1項第3号)';
                } else if (specialReason === '7' || specialReason === '8' || specialReason === '9') {
                    quotationDetail = '原則として**2者以上**の徴取が必要 (特殊事由により競争性を確保)';
                    notes.push('【競争性の確保】第7/8/9号事由が重なる場合、少額でも時価や競争性を比較検討するため、原則として2者以上の見積徴取を強く推奨します。');
                } else {
                    quotationDetail = '原則として**2者以上**の徴取が必要';
                }
                if (priceMan <= 50) notes.push('予定価格調書の作成は省略可能 (50万円以下)');
                else notes.push('予定価格調書を作成すること (50万円超)');
                
                if (priceMan <= priceLimit && priceMan > 10 && specialReason === '0' && quotationDetail.includes('2者以上')) {
                    notes.push('見積予定業者が複数で、執行伺書に根拠条文と見積予定業者(複数者)の記載があれば、理由書の添付は**不要**です。');
                } else if (isSpecialReason) {
                    notes.push('【特殊事由あり】第1号優先適用ですが、特殊事由が重なる場合は「随意契約及び業者選定理由書」を作成添付し、業者選定理由を明確にすること。');
                    if (specialReason === '3') notes.push('**【重要】第3号(福祉施設等)の公表手続きが必要です。**');
                } else if (priceMan <= 10) {
                    notes.push('1者随契で処理する場合、業者選定理由等を執行伺書に記載してください。');
                }
                flowNote = `判定は「第1号優先適用」の原則に基づき行われました。（予定価格 ${priceMan}万円は上限額 ${priceLimit}万円以下）`;
            } else if (isSpecialReason) {
                const detail = REASON_DETAILS[specialReason];
                article = `施行令第167条の2第1項第${specialReason}号 (${detail.name.split('(')[1].replace(')', '')})`;
                if (detail.oneParty) {
                    quotationDetail = '**1者のみの徴取で足りる** (規則第14条第1項による)';
                    if (specialReason === '5') notes.push('【緊急時】可能であれば複数の業者から見積を徴取するなど競争性を確保するよう心がけてください。');
                } else {
                    quotationDetail = '原則として**2者以上**の徴取が必要';
                }
                notes.push(detail.notes);
                notes.push(detail.document);
                notes.push('価格が50万円を超えているため、予定価格調書の作成は必須です。');
                flowNote = `（予定価格 ${priceMan}万円は第1号の上限額 ${priceLimit}万円を超過しています。特殊事由（第${specialReason}号）が適用されました。）`;
            } else {
                article = '随意契約の適用不可';
                quotationDetail = '一般競争入札又は指名競争入札が必要です。';
                notes.push('**【原則】** 地方自治法第234条第2項により、この場合は随意契約は適用できません。**一般競争入札**を原則として検討してください。');
                notes.push('価格が50万円を超えているため、予定価格調書の作成は必須です。');
                contractFormDetail = '入札により、落札金額に応じて契約書または請書が必要です。';
                flowNote = `（予定価格 ${priceMan}万円は上限額 ${priceLimit}万円を超過しており、かつ特殊事由が選択されていません。）`;
            }

            document.getElementById('resultArticle').textContent = article;
            document.getElementById('resultQuotation').textContent = quotationDetail;
            document.getElementById('resultContractForm').textContent = contractFormDetail;
            document.getElementById('resultFlow').textContent = flowNote;
            document.getElementById('note1').textContent = notes[0] || '';
            const remainingNotes = notes.slice(1);
            ['note2', 'note3', 'note4'].forEach((id, index) => { document.getElementById(id).textContent = remainingNotes[index] || ''; });

            const resultProcedure = document.getElementById('resultProcedure');
            resultProcedure.innerHTML = '';
            if (office !== '主管課') {
                resultProcedure.innerHTML = `
                    <div class="step-item">
                        <div class="step-number" style="background-color: var(--attention-color);">1</div>
                        <div>
                            <p class="font-semibold text-red-700">契約検査課への依頼</p>
                            <p class="text-sm text-gray-800">イントラの物品契約(工事入札)管理システムに入力のうえ、出力した執行(施行)伺書に必要書類を添付して提出してください。</p>
                            <p class="text-xs text-gray-600 mt-1">※依頼案件については、「随意契約及び業者選定理由書」の添付は不要です。</p>
                        </div>
                    </div>
                `;
            } else {
                STANDARD_PROCEDURE.forEach((item, index) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step-item';
                    stepDiv.innerHTML = `<div class="step-number">${index + 1}</div><div><p class="font-semibold text-gray-800">${item.step}</p><p class="text-xs text-gray-600">${item.detail}</p></div>`;
                    resultProcedure.appendChild(stepDiv);
                });
            }

            output.classList.remove('hidden');
            output.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('plannedPrice').addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); judgeContract(); } });
        });
    </script>
</body>
</html>
